version:              2

jobs:

  dependencyUpdates:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # dependencyUpdates
    - run:
        name:         Checking dependency updates
        command:      ./gradlew dependencyUpdates
    - store_artifacts:
        path:         build/dependencyUpdates
        destination:  dependencies

    - save_cache:
        paths:
        - ~/.gradle
        key:          v1-dependencies-{{ checksum "build.gradle" }}


  assembleDebug:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # assembleDebug
    - run:
        name:         Running assembleDebug
        command:      ./gradlew assembleDebug -x lint --profile
    - store_artifacts:
        path:         build/reports/profile/
        destination:  profile


    - save_cache:
        paths:
        - ~/.gradle
        key:          v1-dependencies-{{ checksum "build.gradle" }}


  assembleRelease:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # assembleRelease
    - run:
        name:         Running assembleRelease
        command:      ./gradlew assembleRelease -x lint -x lintVitalRelease --profile
    - store_artifacts:
        path:         build/reports/profile/
        destination:  profile


    - save_cache:
        paths:
        - ~/.gradle
        key:          v1-dependencies-{{ checksum "build.gradle" }}


  assembleDebug:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # assembleDebug
    - run:
        name:         Running assembleDebug
        command:      ./gradlew assembleDebug -x lint --profile
    - store_artifacts:
        path:         build/reports/profile/
        destination:  profile


    - save_cache:
        paths:
        - ~/.gradle
        key:          v1-dependencies-{{ checksum "build.gradle" }}


  assembleRelease:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "build.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # assembleRelease
    - run:
        name:         Running assembleRelease
        command:      ./gradlew assembleRelease -x lint -x lintVitalRelease --profile
    - store_artifacts:
        path:         build/reports/profile/
        destination:  profile


    - save_cache:
        paths:
        - ~/.gradle
        key:          v1-dependencies-{{ checksum "build.gradle" }}


  lint_app:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum ".dependencies/dependencies.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # :app:lint
    - run:
        name:         Running lint
        command:      ./gradlew :app:lint
    - store_artifacts:
        path:         build/reports/
        destination:  lint

    - run:
        name:         Running ktlint
        command:      ./gradlew :app:ktlintCheck
    - store_artifacts:
        path:         build/reports/ktlint
        destination:  ktlint


  lint:

    docker:
    - image:          circleci/android:api-28-node8-alpha

    environment:
      JVM_OPTS:       -Xmx2048m
      GRADLE_OPTS:    -Xmx1536m -XX:+HeapDumpOnOutOfMemoryError -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false

    steps:
    - checkout

    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum ".dependencies/dependencies.gradle" }}
        - v1-dependencies-

    - run:
        name:         Downloading dependencies
        command:      ./gradlew androidDependencies


    # lint
    - run:
        name:         Running lint
        command:      ./gradlew lint
    - store_artifacts:
        path:         build/reports/
        destination:  lint

    - run:
        name:         Running ktlint
        command:      ./gradlew ktlintCheck
    - store_artifacts:
        path:         build/reports/ktlint
        destination:  ktlint


workflows:
  version:            2
  pull_request:
    jobs:
    - dependencyUpdates:
        filters:
          branches:
            ignore:
              - master
    - assembleDebug:
        requires:
          - dependencyUpdates
    - assembleRelease:
        requires:
          - dependencies
    - lint_app:
        requires:
          - assembleDebug
          - assembleRelease
    - lint:
        requires:
          - lint_app

  release:
    jobs:
    - dependencyUpdates:
        filters:
          branches:
            only:
              - master
